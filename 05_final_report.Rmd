---
title: "MSD 2019 Final Project"
subtitle: "A replication and extension of Housing, Health, and Happiness by Matias D. Cattaneo, Sebastian Galiani, Paul J. Gertler, Sebastian Martinez, and Roccio Titiunik, American Economic Journal: Economic Policy 2009"
author: "Nancy Thomas (nkt2111), Patrick Alrassy (pa2492), Brigid Lynch (bml2133)"
date: '`r Sys.time()`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
---



The following is a list of all packages used to generate these results. (Leave at very end of file.)

```{r}
sessionInfo()
```

```{r setup, include=FALSE}
library(here)
library(scales)
library(modelr)
library(tidyverse)
library(haven)

theme_set(theme_bw())

knitr::opts_chunk$set(echo = TRUE)

```

# Import Data

Read in the two data files used for replication of the main results. The houshold dataset has information at the houshold level and includes data from both the 2000 Mexican Census and the 2005 Survey. The individual dataset has information at the individual level and includes data from the 2005 Survey.

```{r read-data}
household_dat <- read_dta(file = "PisoFirme_AEJPol-20070024_household.dta")
individual_dat <- read_dta(file = "PisoFirme_AEJPol-20070024_individual.dta")

# replace na with 0
household_dat[is.na(household_dat)] <- 0
individual_dat[is.na(individual_dat)] <- 0
```

Divides the data into treatment and control groups.

```{r divide-treatment-control}
household_treatment <- household_dat %>% filter(dpisofirme == 1)
household_control <- household_dat %>% filter(dpisofirme == 0)
individual_treatment <- individual_dat %>% filter(dpisofirme == 1)
individual_control <- individual_dat %>% filter(dpisofirme == 0)

treat_cont_i <- individual_dat$dpisofirme
treat_cont_hh <- individual_dat$dpisofirme
```

# Model 1: no controls

```{r model-1}
model_1_i <- function(dependent) {
  return(coef(lm(dependent ~ treat_cont_i, individual_dat %>% select(-dpisofirme))))
}

model_1_hh <- function(dependent) {
  return(coef(lm(dependent ~ treat_cont_hh, household_dat %>% select(-dpisofirme))))
}

model_1_coeff <- c(model_1_hh(household_dat$S_shcementfloor)[2],model_1_hh(household_dat$S_cementfloorkit)[2],model_1_hh(household_dat$S_cementfloordin)[2],model_1_hh(household_dat$S_cementfloorbat)[2],model_1_hh(household_dat$S_cementfloorbed)[2],model_1_i(individual_dat$S_parcount)[2],model_1_i(individual_dat$S_diarrhea)[2],model_1_i(individual_dat$S_anemia)[2],model_1_i(individual_dat$S_mccdts)[2],model_1_i(individual_dat$S_pbdypct)[2],model_1_i(individual_dat$S_haz)[2],model_1_i(individual_dat$S_whz)[2],model_1_hh(household_dat$S_satisfloor)[2],model_1_hh(household_dat$S_satishouse)[2],model_1_hh(household_dat$S_satislife)[2],model_1_hh(household_dat$S_cesds)[2],model_1_hh(household_dat$S_pss)[2])

model_1_intercept <- c(model_1_hh(household_dat$S_shcementfloor)[1],model_1_hh(household_dat$S_cementfloorkit)[1],model_1_hh(household_dat$S_cementfloordin)[1],model_1_hh(household_dat$S_cementfloorbat)[1],model_1_hh(household_dat$S_cementfloorbed)[1],model_1_i(individual_dat$S_parcount)[1],model_1_i(individual_dat$S_diarrhea)[1],model_1_i(individual_dat$S_anemia)[1],model_1_i(individual_dat$S_mccdts)[1],model_1_i(individual_dat$S_pbdypct)[1],model_1_i(individual_dat$S_haz)[1],model_1_i(individual_dat$S_whz)[1],model_1_hh(household_dat$S_satisfloor)[1],model_1_hh(household_dat$S_satishouse)[1],model_1_hh(household_dat$S_satislife)[1],model_1_hh(household_dat$S_cesds)[1],model_1_hh(household_dat$S_pss)[1])

variables <- c("share_cement_floors", "kitchen", "dining_room", "bathroom", "bedroom", "parasite","diarrhea","anemia","MacArther","Peabody","height","weight","Sat_floor","Sat_House","Sat_life","Depression","Stress")

Model_1 <- data.frame(var = variables,coeff_1 = model_1_coeff,int_1 = model_1_intercept)
```

# Model 2: age, demographic, and health-habit controls

```{r model-2}
model_2_i <- function(dependent) {
  return(coef(lm(dependent ~ treat_cont_i + individual_dat$S_HHpeople + individual_dat$S_rooms + individual_dat$S_age + individual_dat$S_gender + individual_dat$S_childma + individual_dat$S_childmaage + individual_dat$S_childmaeduc + individual_dat$S_childpa + individual_dat$S_childpaage + individual_dat$S_childpaeduc + individual_dat$S_waterland + individual_dat$S_waterhouse + individual_dat$S_electricity + individual_dat$S_hasanimals + individual_dat$S_animalsinside + individual_dat$S_garbage + individual_dat$S_washhands, individual_dat %>% select(-dpisofirme))))
}

model_2_hh <- function(dependent) {
  return(coef(lm(dependent ~ treat_cont_hh + household_dat$S_HHpeople + household_dat$S_headage + household_dat$S_spouseage + household_dat$S_headeduc + household_dat$S_spouseeduc + household_dat$S_dem1 + household_dat$S_dem2 + household_dat$S_dem3 + household_dat$S_dem4 + household_dat$S_dem5 + household_dat$S_dem6 + household_dat$S_dem7 + household_dat$S_dem8 + household_dat$S_waterland + household_dat$S_waterhouse + household_dat$S_electricity + household_dat$S_hasanimals + household_dat$S_animalsinside + household_dat$S_garbage + household_dat$S_washhands, household_dat %>% select(-dpisofirme))))
}

model_2_coeff <- c(model_2_hh(household_dat$S_shcementfloor)[2],model_2_hh(household_dat$S_cementfloorkit)[2],model_2_hh(household_dat$S_cementfloordin)[2],model_2_hh(household_dat$S_cementfloorbat)[2],model_2_hh(household_dat$S_cementfloorbed)[2],model_2_i(individual_dat$S_parcount)[2],model_2_i(individual_dat$S_diarrhea)[2],model_2_i(individual_dat$S_anemia)[2],model_2_i(individual_dat$S_mccdts)[2],model_2_i(individual_dat$S_pbdypct)[2],model_2_i(individual_dat$S_haz)[2],model_2_i(individual_dat$S_whz)[2],model_2_hh(household_dat$S_satisfloor)[2],model_2_hh(household_dat$S_satishouse)[2],model_2_hh(household_dat$S_satislife)[2],model_2_hh(household_dat$S_cesds)[2],model_2_hh(household_dat$S_pss)[2])

model_2_intercept <- c(model_2_hh(household_dat$S_shcementfloor)[1],model_2_hh(household_dat$S_cementfloorkit)[1],model_2_hh(household_dat$S_cementfloordin)[1],model_2_hh(household_dat$S_cementfloorbat)[1],model_2_hh(household_dat$S_cementfloorbed)[1],model_2_i(individual_dat$S_parcount)[1],model_2_i(individual_dat$S_diarrhea)[1],model_2_i(individual_dat$S_anemia)[1],model_2_i(individual_dat$S_mccdts)[1],model_2_i(individual_dat$S_pbdypct)[1],model_2_i(individual_dat$S_haz)[1],model_2_i(individual_dat$S_whz)[1],model_2_hh(household_dat$S_satisfloor)[1],model_2_hh(household_dat$S_satishouse)[1],model_2_hh(household_dat$S_satislife)[1],model_2_hh(household_dat$S_cesds)[1],model_2_hh(household_dat$S_pss)[1])

Model_2 <- data.frame(var = variables,coeff_2 = model_2_coeff,int_2 = model_2_intercept)
```

# Model 3: age, demographic, health-habit and public social programs controls

```{r model-3}
model_3_i <- function(dependent) {
  return(coef(lm(dependent ~ treat_cont_i + individual_dat$S_HHpeople + individual_dat$S_rooms + individual_dat$S_age + individual_dat$S_gender + individual_dat$S_childma + individual_dat$S_childmaage + individual_dat$S_childmaeduc + individual_dat$S_childpa + individual_dat$S_childpaage + individual_dat$S_childpaeduc + individual_dat$S_waterland + individual_dat$S_waterhouse + individual_dat$S_electricity + individual_dat$S_hasanimals + individual_dat$S_animalsinside + individual_dat$S_garbage + individual_dat$S_washhands + individual_dat$S_cashtransfers + individual_dat$S_milkprogram + individual_dat$S_foodprogram + individual_dat$S_seguropopular, individual_dat %>% select(-dpisofirme))))
}

model_3_hh <- function(dependent) {
  return(coef(lm(dependent ~ treat_cont_hh + household_dat$S_HHpeople + household_dat$S_headage + household_dat$S_spouseage + household_dat$S_headeduc + household_dat$S_spouseeduc + household_dat$S_dem1 + household_dat$S_dem2 + household_dat$S_dem3 + household_dat$S_dem4 + household_dat$S_dem5 + household_dat$S_dem6 + household_dat$S_dem7 + household_dat$S_dem8 + household_dat$S_waterland + household_dat$S_waterhouse + household_dat$S_electricity + household_dat$S_hasanimals + household_dat$S_animalsinside + household_dat$S_garbage + household_dat$S_washhands + household_dat$S_cashtransfers + household_dat$S_milkprogram + household_dat$S_foodprogram + household_dat$S_seguropopular, household_dat %>% select(-dpisofirme))))
}

model_3_coeff <- c(model_3_hh(household_dat$S_shcementfloor)[2],model_3_hh(household_dat$S_cementfloorkit)[2],model_3_hh(household_dat$S_cementfloordin)[2],model_3_hh(household_dat$S_cementfloorbat)[2],model_3_hh(household_dat$S_cementfloorbed)[2],model_3_i(individual_dat$S_parcount)[2],model_3_i(individual_dat$S_diarrhea)[2],model_3_i(individual_dat$S_anemia)[2],model_3_i(individual_dat$S_mccdts)[2],model_3_i(individual_dat$S_pbdypct)[2],model_3_i(individual_dat$S_haz)[2],model_3_i(individual_dat$S_whz)[2],model_3_hh(household_dat$S_satisfloor)[2],model_3_hh(household_dat$S_satishouse)[2],model_3_hh(household_dat$S_satislife)[2],model_3_hh(household_dat$S_cesds)[2],model_3_hh(household_dat$S_pss)[2])

model_3_intercept <- c(model_3_hh(household_dat$S_shcementfloor)[1],model_3_hh(household_dat$S_cementfloorkit)[1],model_3_hh(household_dat$S_cementfloordin)[1],model_3_hh(household_dat$S_cementfloorbat)[1],model_3_hh(household_dat$S_cementfloorbed)[1],model_3_i(individual_dat$S_parcount)[1],model_3_i(individual_dat$S_diarrhea)[1],model_3_i(individual_dat$S_anemia)[1],model_3_i(individual_dat$S_mccdts)[1],model_3_i(individual_dat$S_pbdypct)[1],model_3_i(individual_dat$S_haz)[1],model_3_i(individual_dat$S_whz)[1],model_3_hh(household_dat$S_satisfloor)[1],model_3_hh(household_dat$S_satishouse)[1],model_3_hh(household_dat$S_satislife)[1],model_3_hh(household_dat$S_cesds)[1],model_3_hh(household_dat$S_pss)[1])

Model_3 <- data.frame(var = variables,coeff_3 = model_3_coeff,int_3 = model_3_intercept)
```

# Control Group Means and Standard Deviations

```{r control-mean-sd}
control_mean <- function(dependent) {
  return(mean(dependent))
}

control_sd <- function(dependent) {
  return(sd(dependent))
}

control_mean <- c(control_mean(household_control$S_shcementfloor), control_mean(household_control$S_cementfloorkit), control_mean(household_control$S_cementfloordin), control_mean(household_control$S_cementfloorbat),control_mean(household_control$S_cementfloorbed),control_mean(individual_control$S_parcount),control_mean(individual_control$S_diarrhea),control_mean(individual_control$S_anemia),control_mean(individual_control$S_mccdts),control_mean(individual_control$S_pbdypct),control_mean(individual_control$S_haz),control_mean(individual_control$S_whz),control_mean(household_control$S_satisfloor),control_mean(household_control$S_satishouse),control_mean(household_control$S_satislife),control_mean(household_control$S_cesds),control_mean(household_control$S_pss))

control_sd <- c(control_sd(household_control$S_shcementfloor), control_sd(household_control$S_cementfloorkit), control_sd(household_control$S_cementfloordin),control_sd(household_control$S_cementfloorbat),control_sd(household_control$S_cementfloorbed),control_sd(individual_control$S_parcount),control_sd(individual_control$S_diarrhea),control_sd(individual_control$S_anemia),control_sd(individual_control$S_mccdts),control_sd(individual_control$S_pbdypct),control_sd(individual_control$S_haz),control_sd(individual_control$S_whz),control_sd(household_control$S_satisfloor),control_sd(household_control$S_satishouse),control_sd(household_control$S_satislife),control_sd(household_control$S_cesds),control_sd(household_control$S_pss))

Mean_SD <- data.frame(var = variables, control_group_mean = control_mean, control_group_sd = control_sd)
```

# Compile Results into Tables 4, 5, 6

```{r model-put-together}
Model <- Model_1 %>% left_join(Model_2, by = "var") %>% left_join(Model_3, by = "var") %>% left_join(Mean_SD, by = "var")

Table_4 <- Model %>% filter(var == "share_cement_floors" | var == "kitchen" | var == "dining_room" | var == "bathroom" | var == "bedroom") %>% select(var, control_group_mean, control_group_sd, coeff_1, coeff_2, coeff_3) %>% rename("Model_1" = coeff_1, "Model_2" = coeff_2, "Model_3" = coeff_3, "Dependent" = var)

Table_5 <- Model %>% filter(var == "parasite" | var == "diarrhea" | var == "anemia" | var == "MacArthur" | var == "Peabody" | var == "height" | var == "weight") %>% select(var, control_group_mean, control_group_sd, coeff_1, coeff_2, coeff_3) %>% rename("Model_1" = coeff_1, "Model_2" = coeff_2, "Model_3" = coeff_3, "Dependent" = var)

Table_6 <- Model %>% filter(var == "Sat_floor" | var == "Sat_House" | var == "Sat_life" | var == "Depression" | var == "Stress") %>% select(var, control_group_mean, control_group_sd, coeff_1, coeff_2, coeff_3) %>% rename("Model_1" = coeff_1, "Model_2" = coeff_2, "Model_3" = coeff_3, "Dependent" = var)

```

```{r logistic-regression}
household_dat$dpisofirme <- factor(household_dat$dpisofirme)

#smaller_household <- household_dat %>% select(S_shcementfloor, S_cementfloorkit, S_cementfloordin, S_cementfloorbat, S_cementfloorbed, S_satisfloor, S_satishouse, S_satislife, S_cesds, S_pss)

controlled_household <- household_dat %>% select(S_HHpeople, S_headage, S_spouseage, S_headeduc, S_spouseeduc, S_dem1, S_dem2, S_dem3, S_dem4, S_dem5, S_dem6, S_dem7, S_dem8, S_waterland, S_waterhouse, S_electricity, S_hasanimals, S_animalsinside, S_garbage, S_washhands, S_cashtransfers, S_milkprogram, S_foodprogram, S_seguropopular)

num_rows <- nrow(controlled_household)
frac_train <- 0.8
num_train <- floor(num_rows * frac_train)

ndx <- sample(1:num_rows, num_train, replace=F)

data_train <- controlled_household[ndx, ]
all_train <- household_dat[ndx, ]
data_test <- controlled_household[-ndx, ]
all_test <- household_dat[-ndx, ]

model <- glm(all_train$dpisofirme ~., data=data_train, family = "binomial")

df <- data.frame(actual = all_test$dpisofirme, log_odds = predict(model, data_test)) %>% mutate(pred = ifelse(log_odds > 0, '1', '0'))

table(actual = df$actual, predicted = df$pred)

# accuracy: fraction of correct classifications
df %>%summarize(acc = mean(pred == actual))

# precision: fraction of positive predictions that are actually true
df %>% filter(pred == '1') %>% summarize(prec = mean(actual == '1'))

# recall: fraction of true examples that we predicted to be positive
# aka true positive rate, sensitivity
df %>% filter(actual == '1') %>% summarize(recall = mean(pred == '1'))

# false positive rate: fraction of false examples that we predicted to be positive
df %>% filter(actual == '0') %>% summarize(fpr = mean(pred == '1'))

#probs <- data.frame(predict(model,data_test, type="raw"))

#plot_data <- data_test
#plot_data$probs <- predict(model, data_test, type="response")
#ggplot(plot_data, aes(x = probs)) + geom_histogram(binwidth = 0.01) + xlab('Predicted probability of Treatment') + ylab('Number of examples')

# plot calibration
#data.frame(predicted=plot_data$probs, actual=all_test$dpisofirme) %>% group_by(predicted=round(predicted*10)/10) %>% summarize(num=n(), actual=mean(actual == "1")) %>% ggplot(data=., aes(x=predicted, y=actual, size=num)) + geom_point() + geom_abline(linetype=2) + scale_x_continuous(labels=percent, lim=c(0,1)) + scale_y_continuous(labels=percent, lim=c(0,1)) + xlab('Predicted probability of Treatment') + ylab('Percent that are actually Treatment')

#pred <- prediction(plot_data$probs, yTest)
#perf_lr <- performance(pred, measure='tpr', x.measure='fpr')
#plot(perf_lr)
#performance(pred, 'auc')
```
